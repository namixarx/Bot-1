{% extends "base.html" %}

{% block title %}Dashboard - Telegram Bot Panel{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>Dashboard</h1>
        <p>Welcome back, <strong>{{ user.first_name }} {{ user.last_name }}</strong>! Manage your Telegram bots with ease.</p>
    </div>

    {% if bot_stats %}
    <!-- Statistics Cards -->
    <div class="bot-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 2rem;">
        <div class="card" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(59, 130, 246, 0.2) 100%);">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="width: 50px; height: 50px; border-radius: 12px; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                    <i class="fas fa-robot"></i>
                </div>
                <div>
                    <div style="font-size: 2rem; font-weight: 700; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                        {{ bot_stats|length }}
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">Total Bots</div>
                </div>
            </div>
        </div>
        
        <div class="card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(6, 182, 212, 0.2) 100%);">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="width: 50px; height: 50px; border-radius: 12px; background: var(--gradient-accent); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div>
                    <div style="font-size: 2rem; font-weight: 700; background: var(--gradient-accent); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                        {{ bot_stats|selectattr('bot.is_active')|list|length }}
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">Active Bots</div>
                </div>
            </div>
        </div>
        
        <div class="card" style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.2) 0%, rgba(99, 102, 241, 0.2) 100%);">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="width: 50px; height: 50px; border-radius: 12px; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                    <i class="fas fa-comments"></i>
                </div>
                <div>
                    <div style="font-size: 2rem; font-weight: 700; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                        {{ bot_stats|sum(attribute='messages_count') }}
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">Total Messages</div>
                </div>
            </div>
        </div>
        
        <div class="card" style="background: linear-gradient(135deg, rgba(6, 182, 212, 0.2) 0%, rgba(59, 130, 246, 0.2) 100%);">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="width: 50px; height: 50px; border-radius: 12px; background: var(--gradient-secondary); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                    <i class="fas fa-keyboard"></i>
                </div>
                <div>
                    <div style="font-size: 2rem; font-weight: 700; background: var(--gradient-secondary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                        {{ bot_stats|sum(attribute='buttons_count') }}
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">Total Buttons</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div id="bots">
        <div class="flex flex-between mb-20" style="align-items: center;">
            <h2 style="font-size: 1.75rem; font-weight: 700; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 0;">
                <i class="fas fa-robot" style="margin-right: 0.5rem;"></i>My Bots
            </h2>
            <a href="{{ url_for('create_bot') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Create New Bot
            </a>
        </div>

        {% if bot_stats %}
            <div class="bot-grid">
                {% for stat in bot_stats %}
                <div class="bot-card">
                    <div class="bot-card-header">
                        <h3 class="bot-card-title">
                            <i class="fas fa-robot" style="margin-right: 0.5rem; color: var(--purple);"></i>
                            {{ stat.bot.name }}
                        </h3>
                        <label class="toggle-switch" title="Toggle bot status">
                            <input type="checkbox" 
                                   onchange="toggleBot({{ stat.bot.id }}, this)" 
                                   {% if stat.bot.is_active %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    {% if stat.bot.description %}
                    <p class="bot-card-description">{{ stat.bot.description }}</p>
                    {% else %}
                    <p class="bot-card-description" style="color: var(--text-muted); font-style: italic;">No description provided</p>
                    {% endif %}
                    
                    <div style="margin-bottom: var(--spacing-md);">
                        <span class="badge {% if stat.token_valid %}badge-success{% else %}badge-danger{% endif %}">
                            <i class="fas fa-{% if stat.token_valid %}check{% else %}times{% endif %}"></i>
                            Token: {% if stat.token_valid %}Valid{% else %}Invalid{% endif %}
                        </span>
                        <span class="badge {% if stat.bot.is_active %}badge-success{% else %}badge-danger{% endif %}" style="margin-left: 0.5rem;">
                            <i class="fas fa-{% if stat.bot.is_active %}power-off{% else %}ban{% endif %}"></i>
                            {% if stat.bot.is_active %}Active{% else %}Inactive{% endif %}
                        </span>
                    </div>
                    
                    <div class="bot-card-stats">
                        <div class="bot-stat">
                            <i class="fas fa-comment" style="color: var(--purple);"></i>
                            <span>{{ stat.messages_count }} Messages</span>
                        </div>
                        <div class="bot-stat">
                            <i class="fas fa-keyboard" style="color: var(--cyan);"></i>
                            <span>{{ stat.buttons_count }} Buttons</span>
                        </div>
                    </div>
                    
                    <div class="bot-card-actions">
                        <a href="{{ url_for('edit_bot', bot_id=stat.bot.id) }}" class="btn btn-secondary btn-small">
                            <i class="fas fa-edit"></i> Edit
                        </a>
                        <a href="{{ url_for('manage_messages', bot_id=stat.bot.id) }}" class="btn btn-secondary btn-small">
                            <i class="fas fa-comments"></i> Messages
                        </a>
                        <a href="{{ url_for('manage_buttons', bot_id=stat.bot.id) }}" class="btn btn-secondary btn-small">
                            <i class="fas fa-keyboard"></i> Buttons
                        </a>
                        <a href="{{ url_for('test_bot', bot_id=stat.bot.id) }}" class="btn btn-secondary btn-small">
                            <i class="fas fa-vial"></i> Test
                        </a>
                        <form method="POST" action="{{ url_for('delete_bot', bot_id=stat.bot.id) }}" 
                              onsubmit="return confirm('Are you sure you want to delete this bot? This action cannot be undone.');" 
                              style="display: inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-danger btn-small">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="card text-center empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <h3 style="font-size: 1.5rem; margin-bottom: var(--spacing-md); background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                    No Bots Yet
                </h3>
                <p style="color: var(--text-secondary); margin-bottom: var(--spacing-lg); font-size: 1.1rem;">
                    Get started by creating your first Telegram bot. It only takes a few minutes!
                </p>
                <a href="{{ url_for('create_bot') }}" class="btn btn-primary" style="font-size: 1.1rem; padding: var(--spacing-md) var(--spacing-xl);">
                    <i class="fas fa-plus"></i> Create Your First Bot
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- toggleBot function is now in main.js -->
{% endblock %}
